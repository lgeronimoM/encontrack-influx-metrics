name: 'InfluxDB Metrics Reporter'
description: 'Env√≠a m√©tricas de deploy a InfluxDB usando Line Protocol'
author: 'Luis Ger√≥nimo'

inputs:
  influx_token:
    description: 'Token de autenticaci√≥n de InfluxDB'
    required: true
  job_status:
    description: 'Estado del job (success, failure, cancelled)'
    required: false
    default: 'unknown'
  measurement:
    description: 'Nombre de la medici√≥n (measurement) en InfluxDB'
    required: false
    default: 'github_deploys'

runs:
  using: composite
  steps:
    - name: üìä Enviar m√©trica a InfluxDB
      shell: bash
      env:
        # ‚≠ê VALORES FIJOS - Configuraci√≥n de InfluxDB
        INFLUX_URL: http://10.10.4.81:8087
        INFLUX_ORG: myorg
        INFLUX_BUCKET: github
        # Token desde input (secreto del repo llamador)
        INFLUX_TOKEN: ${{ inputs.influx_token }}
        MEASUREMENT: ${{ inputs.measurement }}
        # Variables de contexto de GitHub
        GH_ACTOR: ${{ github.actor }}
        GH_REPOSITORY: ${{ github.repository }}
        GH_REF_NAME: ${{ github.ref_name }}
        GH_SHA: ${{ github.sha }}
        GH_TS: ${{ github.event.head_commit.timestamp }}
        GH_WORKFLOW: ${{ github.workflow }}
        GH_RUN_NUMBER: ${{ github.run_number }}
        STATUS: ${{ inputs.job_status }}
      run: |
        set -euo pipefail
        
        echo "üîç Verificando configuraci√≥n..."
        if [ -z "$INFLUX_URL" ] || [ -z "$INFLUX_TOKEN" ]; then
          echo "‚ùå Error: Configuraci√≥n de InfluxDB incompleta"
          exit 0  # No fallar el workflow
        fi
        
        # Funci√≥n de escape para Line Protocol
        esc() { sed -E 's/([ ,=])/\\\1/g'; }
        
        user=$(printf '%s' "${GH_ACTOR:-unknown}" | esc)
        repo=$(printf '%s' "${GH_REPOSITORY:-unknown}" | esc)
        branch=$(printf '%s' "${GH_REF_NAME:-unknown}" | esc)
        status=$(printf '%s' "${STATUS:-unknown}" | esc)
        workflow=$(printf '%s' "${GH_WORKFLOW:-unknown}" | esc)
        sha=$(printf '%s' "${GH_SHA:0:7}" | esc)
        measurement="${MEASUREMENT:-github_deploys}"
        
        # Timestamp en nanosegundos
        if [ -n "${GH_TS:-}" ]; then
          TS=$(date -u -d "$GH_TS" +%s%N 2>/dev/null || date -u +%s%N)
        else
          TS=$(date -u +%s%N)
        fi
        
        # Line Protocol
        LINE="${measurement},user=${user},repo=${repo},branch=${branch},status=${status},workflow=${workflow},sha=${sha} value=1,run_number=${GH_RUN_NUMBER}i ${TS}"
        
        echo "üì§ Enviando m√©trica a InfluxDB..."
        echo "  URL: ${INFLUX_URL}"
        echo "  Org: ${INFLUX_ORG}"
        echo "  Bucket: ${INFLUX_BUCKET}"
        echo "  Repo: ${GH_REPOSITORY}"
        echo "  Branch: ${GH_REF_NAME}"
        echo "  Status: ${STATUS}"
        echo "  SHA: ${GH_SHA:0:7}"
        
        if curl -sfS -X POST "$INFLUX_URL/api/v2/write?org=$INFLUX_ORG&bucket=$INFLUX_BUCKET&precision=ns" \
          -H "Authorization: Token $INFLUX_TOKEN" \
          -H "Content-Type: text/plain; charset=utf-8" \
          --data-binary "$LINE"; then
          echo "‚úÖ M√©trica enviada exitosamente a InfluxDB"
        else
          echo "‚ö†Ô∏è No se pudo enviar la m√©trica (c√≥digo: $?)"
        fi

branding:
  icon: 'activity'
  color: 'blue'
